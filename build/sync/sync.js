// Generated by CoffeeScript 1.8.0
(function() {
  var ApiError, Gmail, IMessage, IMessagePart, IQueryToTasklist, ITask, ITaskList, ITaskLists, ITasks, IThread, IThreads, Promise, States, Sync, TaskListSync, async, asyncmachine, auth, coroutine, google, promisify, type, _ref,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  auth = require('../auth');

  TaskListSync = require('./task-list-sync');

  type = require('../type');

  asyncmachine = require('asyncmachine');

  google = require('googleapis');

  async = require('async');

  Promise = require('bluebird');

  Gmail = require('./gmail').Gmail;

  ApiError = require('../exceptions').ApiError;

  Promise.longStackTraces();

  coroutine = Promise.coroutine;

  promisify = Promise.promisify;

  _ref = require('./api-types'), ITaskList = _ref.ITaskList, ITaskLists = _ref.ITaskLists, IQueryToTasklist = _ref.IQueryToTasklist, IThread = _ref.IThread, IThreads = _ref.IThreads, ITask = _ref.ITask, ITasks = _ref.ITasks, IMessage = _ref.IMessage, IMessagePart = _ref.IMessagePart;

  States = (function(_super) {
    __extends(States, _super);

    States.prototype.Enabled = {
      auto: true
    };

    States.prototype.Authenticating = {
      auto: true,
      requires: ['Enabled'],
      blocks: ['Authenticated']
    };

    States.prototype.Authenticated = {
      blocks: ['Authenticating']
    };

    States.prototype.Syncing = {
      auto: true,
      requires: ['Enabled', 'Authenticated'],
      blocks: ['Synced']
    };

    States.prototype.Synced = {
      requires: ['Enabled', 'Authenticated', 'TaskListsSynced', 'QueryLabelsSynced'],
      blocks: ['Syncing']
    };

    States.prototype.TaskListSyncEnabled = {
      auto: true,
      requires: ['TaskListsFetched', 'QueryLabelsSynced']
    };

    States.prototype.GmailEnabled = {
      auto: true
    };

    States.prototype.GmailSyncEnabled = {
      auto: true
    };

    States.prototype.FetchingTaskLists = {
      auto: true,
      requires: ['Enabled'],
      blocks: ['TaskListsFetched']
    };

    States.prototype.TaskListsFetched = {
      blocks: ['FetchingTaskLists']
    };

    States.prototype.QueryLabelsSynced = {};

    States.prototype.SyncingTaskLists = {};

    States.prototype.TaskListsSynced = {};

    States.prototype.Dirty = {};

    function States() {
      States.__super__.constructor.apply(this, arguments);
      this.registerAll();
    }

    return States;

  })(asyncmachine.AsyncMachine);

  Sync = (function() {
    Sync.prototype.states = null;

    Sync.prototype.config = null;

    Sync.prototype.auth = null;

    Sync.prototype.tasks_api = null;

    Sync.prototype.gmail_api = null;

    Sync.prototype.task_lists = null;

    Sync.prototype.etags = null;

    Sync.prototype.history_id = null;

    Object.defineProperty(Sync.prototype, 'history_id', {
      set: function(history_id) {
        return this.historyId = Math.max(this.history_id, history_id);
      }
    });

    function Sync(config) {
      this.config = config;
      this.states = new States;
      this.states.setTarget(this);
      if (process.env['DEBUG']) {
        this.states.debug('Sync / ', process.env['DEBUG']);
      }
      this.task_lists = [];
      this.labels = [];
      this.auth = new auth.Auth(config);
      this.task_lists_sync = [];
      this.etags = {};
      this.tasks_api = new google.tasks('v1', {
        auth: this.auth.client
      });
      this.gmail_api = new google.gmail('v1', {
        auth: this.auth.client
      });
      this.gmail = new Gmail(this);
      this.states.pipeForward('GmailEnabled', this.gmail.states, 'Enabled');
      this.states.pipeForward('GmailSyncEnabled', this.gmail.states, 'SyncingEnabled');
      this.initQueries();
      this.auth.pipeForward('Ready', this.states, 'Authenticated');
    }

    Sync.prototype.QueryLabelsSynced_state = function() {
      return this.states.add('Synced');
    };

    Sync.prototype.TaskListsSynced_state = function() {
      return this.states.add('Synced');
    };

    Sync.prototype.FetchingTaskLists_state = coroutine(function*() {
      var abort, res;
      abort = this.states.getAbort('FetchingTaskLists');
      res = (yield this.req(this.tasks_api.tasklists.list, {
        etag: this.etags.task_lists
      }));
      if (typeof abort === "function" ? abort() : void 0) {
        console.log('abort', abort);
        return;
      }
      if (res[1].statusCode !== 304) {
        console.log('[FETCHED] tasks lists');
        this.etags.task_lists = res[1].headers.etag;
        this.task_lists = type(res[0].items, ITaskLists, 'ITaskLists');
      } else {
        console.log('[CACHED] tasks lists');
      }
      return this.states.add('TaskListsFetched');
    });

    Sync.prototype.TaskListsSynced_enter = function() {
      return this.task_lists_sync.every(function(list) {
        return list.states.is('Synced');
      });
    };

    Sync.prototype.SyncingTaskLists_exit = function() {
      return !this.task_lists_sync.some(function(list) {
        return list.states.is('Syncing');
      });
    };

    Sync.prototype.Synced_state = function() {
      console.log('!!! SYNCED !!!');
      this.last_sync_end = new Date();
      this.last_sync_time = this.last_sync_end - this.last_sync_start;
      console.log("Time: " + this.last_sync_time + "ms");
      if (this.next_sync_timeout) {
        clearTimeout(this.next_sync_timeout);
      }
      return this.next_sync_timeout = setTimeout(this.states.addByListener('Syncing'), this.config.sync_frequency);
    };

    Sync.prototype.Syncing_state = function() {
      var list, _i, _len, _ref1, _results;
      console.log('--- SYNCING ---');
      this.last_sync_start = new Date();
      this.last_sync_end = null;
      this.last_sync_time = null;
      if (this.states.is('Dirty')) {
        this.states.add(this.gmail.states, 'Dirty');
        this.states.drop('Dirty');
      } else {
        this.states.drop(this.gmail.states, 'QueryLabelsSynced');
      }
      _ref1 = this.task_lists_sync;
      _results = [];
      for (_i = 0, _len = _ref1.length; _i < _len; _i++) {
        list = _ref1[_i];
        _results.push(this.states.add(list.states, 'Restart'));
      }
      return _results;
    };

    Sync.prototype.initQueries = function() {
      var data, name, task_list, _ref1, _results;
      _ref1 = this.config.tasks.queries;
      _results = [];
      for (name in _ref1) {
        data = _ref1[name];
        if (name === 'labels_defaults') {
          continue;
        }
        task_list = new TaskListSync(name, data, this);
        this.states.pipeForward('TaskListSyncEnabled', task_list.states, 'Enabled');
        task_list.states.pipeForward('Synced', this.states, 'TaskListsSynced');
        task_list.states.pipeForward('Syncing', this.states, 'SyncingTaskLists');
        _results.push(this.task_lists_sync.push(task_list));
      }
      return _results;
    };

    Sync.prototype.req = coroutine(function*(method, params) {
      if (params == null) {
        params = {};
      }
      this.log(['REQUEST', params], 3);
      params.auth = this.auth.client;
      method = promisify(method);
      return (yield method(params));
    });

    Sync.prototype.log = function(msgs, level) {
      if (!process.env['DEBUG']) {
        return;
      }
      if (level && level > process.env['DEBUG']) {
        return;
      }
      if (!(msgs instanceof Array)) {
        msgs = [msgs];
      }
      return console.log.apply(console, msgs);
    };

    return Sync;

  })();

  module.exports = {
    Sync: Sync,
    States: States
  };

}).call(this);
